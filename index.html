<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PESQUERA RINCON DEL MAR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        /* =================== ESTILOS DE LOGIN =================== */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .login-header p {
            color: #666;
            font-size: 1.1em;
        }

        .login-form {
            margin-bottom: 20px;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .login-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .login-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        .login-error {
            background: linear-gradient(45deg, #f8d7da, #f1b0b7);
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f1b0b7;
            font-weight: bold;
        }

        .show-password {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
        }

        .show-password input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .sistema-principal {
            display: none;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: white;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            border-right: 1px solid #dee2e6;
            font-weight: bold;
            color: #495057;
        }

        .tab:last-child {
            border-right: none;
        }

        .tab.active {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tab:hover:not(.active) {
            background: #f1f3f4;
            transform: translateY(-1px);
        }

        .content {
            padding: 30px;
            min-height: 600px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: end;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }

        .btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: linear-gradient(45deg, #f8d7da, #f1b0b7);
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .alert-warning {
            background: linear-gradient(45deg, #fff3cd, #ffe8a1);
            color: #856404;
            border: 1px solid #ffe8a1;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .table thead {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
        }

        .table th, .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .status-dot.disconnected {
            background: #dc3545;
        }

        .status-dot.connecting {
            background: #ffc107;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .venta-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .venta-item:hover {
            background: #e9ecef;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .config-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .config-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #facturaImpresion, #facturaImpresion * {
                visibility: visible;
            }
            #facturaImpresion {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        .factura-preview {
            background: white;
            padding: 30px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            margin-top: 20px;
        }

        .factura-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 20px;
        }

        .factura-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .factura-productos {
            margin-bottom: 30px;
        }

        .factura-total {
            text-align: right;
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            border-top: 3px solid #3498db;
            padding-top: 20px;
        }
        
        /* Nuevo estilo para campos calculados */
        .form-group.calculated {
            position: relative;
        }
        
        .form-group.calculated input {
            background-color: #e8f5e9;
            border-color: #4caf50;
        }
        
        .form-group.calculated::after {
            content: 'üî¢ Calculado';
            position: absolute;
            right: 10px;
            top: 38px;
            font-size: 12px;
            color: #4caf50;
            font-weight: bold;
        }
        
        /* Estilo para la tarjeta de ganancias del mes */
        .stat-card.profit {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>üêü PESQUERA</h1>
                <p>Rinc√≥n del Mar</p>
            </div>

            <div id="loginError" class="login-error" style="display: none;"></div>

            <form id="loginForm" class="login-form" onsubmit="iniciarSesion(event)">
                <input 
                    type="text" 
                    id="username" 
                    placeholder="Usuario" 
                    required 
                    autocomplete="username"
                >
                <input 
                    type="password" 
                    id="password" 
                    placeholder="Contrase√±a" 
                    required 
                    autocomplete="current-password"
                >

                <label class="show-password">
                    <input 
                        type="checkbox" 
                        id="showPassword" 
                        onchange="togglePassword()"
                    >
                    Mostrar contrase√±a
                </label>

                <button type="submit" id="loginBtn" class="login-btn">
                    üîë INICIAR SESI√ìN
                </button>
            </form>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="sistemaPrincipal" class="sistema-principal">
        <button class="logout-btn" onclick="cerrarSesion()">üö™ Cerrar Sesi√≥n</button>

        <div class="container">
            <div class="header">
                <h1>üêü PESQUERA RINCON DEL MAR</h1>
                <p>Sistema de Gesti√≥n Integral</p>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="cambiarTab('ventas')">üí∞ VENTAS</div>
                <div class="tab" onclick="cambiarTab('inventario')">üì¶ INVENTARIO</div>
                <div class="tab" onclick="cambiarTab('precios')">üíµ PRECIOS</div>
                <div class="tab" onclick="cambiarTab('reportes')">üìä REPORTES</div>
                <div class="tab" onclick="cambiarTab('configuracion')">‚öôÔ∏è CONFIGURACI√ìN</div>
            </div>

            <div class="content">
                <div id="alertContainer"></div>

                <!-- SECCI√ìN VENTAS -->
                <div id="ventas" class="section active">
                    <h2>üí∞ Nueva Venta</h2>

                    <div class="form-group">
                        <label>Cliente:</label>
                        <input type="text" id="clienteVenta" placeholder="Nombre del cliente">
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label>Tipo de Producto:</label>
                            <select id="tipoProductoVenta">
                                <option value="">Seleccione un producto</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Cantidad (lbs):</label>
                            <input type="number" id="cantidadVenta" step="0.1" min="0.1" placeholder="0.0">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <button class="btn" onclick="agregarProductoVenta()">‚ûï Agregar</button>
                        </div>
                    </div>

                    <div id="productosVenta"></div>

                    <div class="form-group">
                        <div class="factura-total">
                            <strong>TOTAL: <span id="totalVenta">$0.00</span></strong>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="finalizarVenta()" style="width: 100%; padding: 20px; font-size: 1.2em;">
                        üßæ FINALIZAR VENTA
                    </button>
                </div>

                <!-- SECCI√ìN INVENTARIO -->
                <div id="inventario" class="section">
                    <h2>üì¶ Control de Inventario</h2>

                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label>Tipo de Producto:</label>
                            <select id="tipoProductoInventario">
                                <option value="">Seleccione un producto</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Cantidad (lbs):</label>
                            <input type="number" id="cantidadInventario" step="0.1" placeholder="0.0">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Precio Compra ($/lb):</label>
                            <input type="number" id="precioCompraInventario" step="1" placeholder="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <button class="btn btn-primary" onclick="agregarInventario()">‚ûï AGREGAR STOCK</button>
                        <button class="btn btn-danger" onclick="restarInventario()">‚ûñ RESTAR STOCK</button>
                        <button class="btn btn-warning" onclick="cargarInventario()">üîÑ ACTUALIZAR</button>
                    </div>

                    <table class="table" id="tablaInventario">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Stock (lbs)</th>
                                <th>Precio Promedio</th>
                                <th>Valor Total</th>
                                <th>√öltima Actualizaci√≥n</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- SECCI√ìN PRECIOS -->
                <div id="precios" class="section">
                    <h2>üíµ Gesti√≥n de Precios</h2>

                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label>Tipo de Producto:</label>
                            <select id="tipoProductoPrecio">
                                <option value="">Seleccione un producto</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Precio Compra ($/lb):</label>
                            <input type="number" id="precioCompra" step="1" placeholder="0" oninput="calcularMargenAutomatico()">
                        </div>
                        <div class="form-group calculated" style="flex: 1;">
                            <label>Margen de Ganancia (%):</label>
                            <input type="number" id="margenGanancia" step="1" placeholder="0" readonly>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label>Precio Venta ($/lb):</label>
                            <input type="number" id="precioVenta" step="1" placeholder="0" oninput="calcularMargenAutomatico()">
                        </div>
                        <div class="form-group calculated" style="flex: 1;">
                            <label>Ganancia por Libra ($):</label>
                            <input type="number" id="gananciaPorLibra" step="1" placeholder="0" readonly>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <button class="btn btn-primary" onclick="actualizarPrecio()" style="width: 100%;">üíæ GUARDAR PRECIO</button>
                        </div>
                    </div>

                    <button class="btn btn-warning" onclick="cargarPrecios()">üîÑ ACTUALIZAR TABLA</button>

                    <table class="table" id="tablaPrecios">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Precio Compra</th>
                                <th>Margen (%)</th>
                                <th>Precio Venta</th>
                                <th>Ganancia ($/lb)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- SECCI√ìN REPORTES -->
                <div id="reportes" class="section">
                    <h2>üìä Reportes y Estad√≠sticas</h2>

                    <button class="btn btn-warning" onclick="cargarReportes()">üîÑ ACTUALIZAR REPORTES</button>

                    <div class="stats-container">
                        <div class="stat-card success">
                            <h3>üí∞ Total Ventas Hoy</h3>
                            <div class="stat-value" id="totalVentasHoy">$0.00</div>
                        </div>
                        <div class="stat-card info">
                            <h3>üìÖ Total Ventas del Mes</h3>
                            <div class="stat-value" id="totalVentasMes">$0.00</div>
                        </div>
                        <div class="stat-card profit">
                            <h3>üíµ Ganancias del Mes</h3>
                            <div class="stat-value" id="gananciasMes">$0.00</div>
                        </div>
                        <div class="stat-card warning">
                            <h3>üì¶ Valor en Inventario</h3>
                            <div class="stat-value" id="totalInventario">$0.00</div>
                        </div>
                        <div class="stat-card danger">
                            <h3>üßæ N√∫mero de Facturas</h3>
                            <div class="stat-value" id="numeroFacturas">0</div>
                        </div>
                    </div>

                    <h3>üïí √öltimas Ventas</h3>
                    <table class="table" id="tablaUltimasVentas">
                        <thead>
                            <tr>
                                <th>Factura</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Productos</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <h3>‚ö†Ô∏è Productos con Stock Bajo</h3>
                    <table class="table" id="tablaStockBajo">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Stock Actual</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- SECCI√ìN CONFIGURACI√ìN -->
                <div id="configuracion" class="section">
                    <h2>‚öôÔ∏è Configuraci√≥n del Sistema</h2>

                    <div class="connection-status">
                        <div class="status-dot disconnected" id="statusDot"></div>
                        <span id="statusText">No conectado</span>
                    </div>

                    <div class="config-section">
                        <h3>üîó Conexi√≥n a Google Sheets</h3>
                        <div class="form-group">
                            <label>ID de la Hoja de C√°lculo:</label>
                            <input type="text" id="spreadsheetId" placeholder="Ejemplo: 1a2b3c4d5e6f7g8h9i0j">
                        </div>
                        <button class="btn btn-primary" onclick="guardarConfiguracion()">üíæ GUARDAR Y CONECTAR</button>
                    </div>

                    <div class="config-section">
                        <h3>üè¢ Informaci√≥n de la Empresa</h3>
                        <div class="form-group">
                            <label>Nombre de la Empresa:</label>
                            <input type="text" id="nombreEmpresa" placeholder="PESQUERA RINCON DEL MAR">
                        </div>
                        <div class="form-group">
                            <label>Direcci√≥n:</label>
                            <input type="text" id="direccionEmpresa" placeholder="Direcci√≥n de la empresa">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono:</label>
                            <input type="text" id="telefonoEmpresa" placeholder="Tel√©fono de contacto">
                        </div>
                        <button class="btn btn-primary" onclick="guardarDatosEmpresa()">üíæ GUARDAR DATOS</button>
                    </div>

                    <div class="config-section">
                        <h3>üîÑ Mantenimiento</h3>
                        <button class="btn btn-warning" onclick="cargarTodosLosDatos()">üîÑ RECARGAR TODOS LOS DATOS</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Factura para Impresi√≥n (oculta) -->
    <div id="facturaImpresion" style="display: none;"></div>

    <script>
        // =================== VARIABLES GLOBALES ===================
        let spreadsheetId = localStorage.getItem('spreadsheetId') || '';
        let preciosData = {};
        let inventarioData = {};
        let ventaActual = [];
        let numeroFactura = 1;

        const SHEETS_API_KEY = 'AIzaSyCKvmqXmXBj5LcCKM-4jSzL7p82sihWL_8';

        let config = {
            nombreEmpresa: localStorage.getItem('nombreEmpresa') || 'PESQUERA RINCON DEL MAR',
            direccionEmpresa: localStorage.getItem('direccionEmpresa') || '',
            telefonoEmpresa: localStorage.getItem('telefonoEmpresa') || ''
        };

        // =================== FUNCIONES DE NAVEGACI√ìN ===================

        function cambiarTab(tabName) {
            // Desactivar todas las tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));

            // Activar la tab seleccionada
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            console.log('üìå Tab cambiada a:', tabName);
        }

        // =================== FUNCIONES DE UTILIDADES ===================

        function formatearPesos(valor) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor);
        }

        function mostrarAlerta(mensaje, tipo = 'success') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo}`;
            alert.textContent = mensaje;
            alert.style.display = 'block';

            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function updateConnectionStatus(status, message) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            statusDot.className = `status-dot ${status}`;
            statusText.textContent = message;

            console.log(`üì° Estado de conexi√≥n: ${status} - ${message}`);
        }

        // =================== FUNCIONES DE GOOGLE SHEETS API ===================

        async function leerHoja(rango) {
            if (!spreadsheetId) {
                throw new Error('No se ha configurado el ID de la hoja de c√°lculo');
            }

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${rango}?key=${SHEETS_API_KEY}`;

            console.log('üìñ Leyendo hoja:', rango);

            const response = await fetch(url);

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || 'Error al leer la hoja');
            }

            const data = await response.json();
            console.log('‚úÖ Datos le√≠dos de', rango, ':', data.values);

            return data.values || [];
        }

        async function escribirHoja(rango, valores) {
            if (!spreadsheetId) {
                throw new Error('No se ha configurado el ID de la hoja de c√°lculo');
            }

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${rango}?valueInputOption=RAW&key=${SHEETS_API_KEY}`;

            console.log('‚úçÔ∏è Escribiendo en hoja:', rango, valores);

            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    values: valores
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || 'Error al escribir en la hoja');
            }

            const data = await response.json();
            console.log('‚úÖ Datos escritos en', rango);

            return data;
        }

        async function agregarFila(rango, valores) {
            if (!spreadsheetId) {
                throw new Error('No se ha configurado el ID de la hoja de c√°lculo');
            }

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${rango}:append?valueInputOption=RAW&key=${SHEETS_API_KEY}`;

            console.log('‚ûï Agregando fila a:', rango, valores);

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    values: [valores]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || 'Error al agregar fila');
            }

            const data = await response.json();
            console.log('‚úÖ Fila agregada a', rango);

            return data;
        }

        // =================== FUNCIONES DE PRECIOS ===================
        
        // Nueva funci√≥n para calcular el margen autom√°ticamente
        function calcularMargenAutomatico() {
            const precioCompra = parseFloat(document.getElementById('precioCompra').value) || 0;
            const precioVenta = parseFloat(document.getElementById('precioVenta').value) || 0;
            
            if (precioCompra > 0 && precioVenta > 0) {
                // Calcular margen de ganancia en porcentaje
                const ganancia = precioVenta - precioCompra;
                const margen = (ganancia / precioCompra) * 100;
                
                // Actualizar campos calculados
                document.getElementById('margenGanancia').value = margen.toFixed(2);
                document.getElementById('gananciaPorLibra').value = ganancia.toFixed(0);
            } else {
                document.getElementById('margenGanancia').value = '';
                document.getElementById('gananciaPorLibra').value = '';
            }
        }

        async function cargarPrecios() {
            updateConnectionStatus('connecting', 'Cargando precios...');

            try {
                const datos = await leerHoja('Precios!A2:E100');

                preciosData = {};
                const selectVenta = document.getElementById('tipoProductoVenta');
                const selectInventario = document.getElementById('tipoProductoInventario');
                const selectPrecio = document.getElementById('tipoProductoPrecio');

                selectVenta.innerHTML = '<option value="">Seleccione un producto</option>';
                selectInventario.innerHTML = '<option value="">Seleccione un producto</option>';
                selectPrecio.innerHTML = '<option value="">Seleccione un producto</option>';

                datos.forEach(fila => {
                    if (fila[0]) {
                        const tipo = fila[0];
                        preciosData[tipo] = {
                            precioCompra: parseFloat(fila[1]) || 0,
                            margen: parseFloat(fila[2]) || 0,
                            precioVenta: parseFloat(fila[3]) || 0,
                            ganancia: parseFloat(fila[4]) || 0
                        };

                        const option1 = new Option(tipo, tipo);
                        const option2 = new Option(tipo, tipo);
                        const option3 = new Option(tipo, tipo);

                        selectVenta.add(option1);
                        selectInventario.add(option2);
                        selectPrecio.add(option3);
                    }
                });

                actualizarTablaPrecios();
                updateConnectionStatus('connected', 'Precios cargados correctamente');
                console.log('‚úÖ Precios cargados:', preciosData);

            } catch (error) {
                updateConnectionStatus('disconnected', `Error: ${error.message}`);
                mostrarAlerta(`Error al cargar precios: ${error.message}`, 'danger');
            }
        }

        function actualizarTablaPrecios() {
            const tbody = document.querySelector('#tablaPrecios tbody');
            tbody.innerHTML = '';

            Object.entries(preciosData).forEach(([tipo, datos]) => {
                const fila = tbody.insertRow();
                fila.innerHTML = `
                    <td>${tipo}</td>
                    <td>${formatearPesos(datos.precioCompra)}</td>
                    <td>${datos.margen.toFixed(2)}%</td>
                    <td>${formatearPesos(datos.precioVenta)}</td>
                    <td>${formatearPesos(datos.ganancia)}</td>
                `;
            });
        }

        async function actualizarPrecio() {
            const tipo = document.getElementById('tipoProductoPrecio').value;
            const precioCompra = parseFloat(document.getElementById('precioCompra').value) || 0;
            const margen = parseFloat(document.getElementById('margenGanancia').value) || 0;
            const precioVenta = parseFloat(document.getElementById('precioVenta').value) || 0;
            const ganancia = parseFloat(document.getElementById('gananciaPorLibra').value) || 0;

            if (!tipo) {
                mostrarAlerta('Seleccione un tipo de producto', 'warning');
                return;
            }

            if (precioCompra <= 0 || precioVenta <= 0) {
                mostrarAlerta('Ingrese precios v√°lidos', 'warning');
                return;
            }

            updateConnectionStatus('connecting', 'Actualizando precio...');

            try {
                const datos = await leerHoja('Precios!A2:E100');
                let filaEncontrada = -1;

                datos.forEach((fila, index) => {
                    if (fila[0] === tipo) {
                        filaEncontrada = index + 2;
                    }
                });

                if (filaEncontrada !== -1) {
                    await escribirHoja(`Precios!A${filaEncontrada}:E${filaEncontrada}`, [[tipo, precioCompra, margen, precioVenta, ganancia]]);
                } else {
                    await agregarFila('Precios!A:E', [tipo, precioCompra, margen, precioVenta, ganancia]);
                }

                preciosData[tipo] = { precioCompra, margen, precioVenta, ganancia };
                actualizarTablaPrecios();

                document.getElementById('precioCompra').value = '';
                document.getElementById('margenGanancia').value = '';
                document.getElementById('precioVenta').value = '';
                document.getElementById('gananciaPorLibra').value = '';
                document.getElementById('tipoProductoPrecio').value = '';

                updateConnectionStatus('connected', 'Precio actualizado correctamente');
                mostrarAlerta('Precio actualizado correctamente', 'success');

            } catch (error) {
                updateConnectionStatus('disconnected', `Error: ${error.message}`);
                mostrarAlerta(`Error al actualizar precio: ${error.message}`, 'danger');
            }
        }

        // =================== FUNCIONES DE INVENTARIO ===================

        async function cargarInventario() {
            updateConnectionStatus('connecting', 'Cargando inventario...');

            try {
                const datos = await leerHoja('Inventario!A2:E100');

                inventarioData = {};

                datos.forEach(fila => {
                    if (fila[0]) {
                        inventarioData[fila[0]] = {
                            stock: parseFloat(fila[1]) || 0,
                            precioPromedio: parseFloat(fila[2]) || 0,
                            valorTotal: parseFloat(fila[3]) || 0,
                            ultimaActualizacion: fila[4] || ''
                        };
                    }
                });

                actualizarTablaInventario();
                updateConnectionStatus('connected', 'Inventario cargado correctamente');
                console.log('‚úÖ Inventario cargado:', inventarioData);

            } catch (error) {
                updateConnectionStatus('disconnected', `Error: ${error.message}`);
                mostrarAlerta(`Error al cargar inventario: ${error.message}`, 'danger');
            }
        }

        function actualizarTablaInventario() {
            const tbody = document.querySelector('#tablaInventario tbody');
            tbody.innerHTML = '';

            Object.entries(inventarioData).forEach(([tipo, datos]) => {
                const fila = tbody.insertRow();

                let claseStock = '';
                if (datos.stock === 0) {
                    claseStock = 'style="background-color: #f8d7da;"';
                } else if (datos.stock < 5) {
                    claseStock = 'style="background-color: #fff3cd;"';
                }

                fila.innerHTML = `
                    <td>${tipo}</td>
                    <td ${claseStock}>${datos.stock.toFixed(1)} lbs</td>
                    <td>${formatearPesos(datos.precioPromedio)}</td>
                    <td>${formatearPesos(datos.valorTotal)}</td>
                    <td>${datos.ultimaActualizacion}</td>
                `;
            });
        }

        async function agregarInventario() {
            const tipo = document.getElementById('tipoProductoInventario').value;
            const cantidad = parseFloat(document.getElementById('cantidadInventario').value) || 0;
            const precioCompra = parseFloat(document.getElementById('precioCompraInventario').value) || 0;

            if (!tipo || cantidad <= 0 || precioCompra <= 0) {
                mostrarAlerta('Complete todos los campos correctamente', 'warning');
                return;
            }

            updateConnectionStatus('connecting', 'Actualizando inventario...');

            try {
                const stockActual = inventarioData[tipo]?.stock || 0;
                const precioPromActual = inventarioData[tipo]?.precioPromedio || 0;
                const valorActual = inventarioData[tipo]?.valorTotal || 0;

                const nuevoStock = stockActual + cantidad;
                const nuevoValorTotal = valorActual + (cantidad * precioCompra);
                const nuevoPrecioPromedio = nuevoValorTotal / nuevoStock;
                const fechaActual = new Date().toISOString().split('T')[0];

                const datos = await leerHoja('Inventario!A2:E100');
                let filaEncontrada = -1;

                datos.forEach((fila, index) => {
                    if (fila[0] === tipo) {
                        filaEncontrada = index + 2;
                    }
                });

                if (filaEncontrada !== -1) {
                    await escribirHoja(`Inventario!A${filaEncontrada}:E${filaEncontrada}`, 
                        [[tipo, nuevoStock, nuevoPrecioPromedio, nuevoValorTotal, fechaActual]]);
                } else {
                    await agregarFila('Inventario!A:E', 
                        [tipo, nuevoStock, nuevoPrecioPromedio, nuevoValorTotal, fechaActual]);
                }

                inventarioData[tipo] = {
                    stock: nuevoStock,
                    precioPromedio: nuevoPrecioPromedio,
                    valorTotal: nuevoValorTotal,
                    ultimaActualizacion: fechaActual
                };

                actualizarTablaInventario();

                document.getElementById('cantidadInventario').value = '';
                document.getElementById('precioCompraInventario').value = '';
                document.getElementById('tipoProductoInventario').value = '';

                updateConnectionStatus('connected', 'Inventario actualizado correctamente');
                mostrarAlerta(`Se agregaron ${cantidad} lbs de ${tipo}`, 'success');

            } catch (error) {
                updateConnectionStatus('disconnected', `Error: ${error.message}`);
                mostrarAlerta(`Error al actualizar inventario: ${error.message}`, 'danger');
            }
        }

        async function restarInventario() {
            const tipo = document.getElementById('tipoProductoInventario').value;
            const cantidad = parseFloat(document.getElementById('cantidadInventario').value) || 0;

            if (!tipo || cantidad <= 0) {
                mostrarAlerta('Complete todos los campos correctamente', 'warning');
                return;
            }

            const stockActual = inventarioData[tipo]?.stock || 0;

            if (cantidad > stockActual) {
                mostrarAlerta(`No hay suficiente stock. Stock actual: ${stockActual.toFixed(1)} lbs`, 'danger');
                return;
            }

            updateConnectionStatus('connecting', 'Actualizando inventario...');

            try {
                const precioPromActual = inventarioData[tipo]?.precioPromedio || 0;
                const nuevoStock = stockActual - cantidad;
                const nuevoValorTotal = nuevoStock * precioPromActual;
                const fechaActual = new Date().toISOString().split('T')[0];

                const datos = await leerHoja('Inventario!A2:E100');
                let filaEncontrada = -1;

                datos.forEach((fila, index) => {
                    if (fila[0] === tipo) {
                        filaEncontrada = index + 2;
                    }
                });

                if (filaEncontrada !== -1) {
                    await escribirHoja(`Inventario!A${filaEncontrada}:E${filaEncontrada}`, 
                        [[tipo, nuevoStock, precioPromActual, nuevoValorTotal, fechaActual]]);
                }

                inventarioData[tipo] = {
                    stock: nuevoStock,
                    precioPromedio: precioPromActual,
                    valorTotal: nuevoValorTotal,
                    ultimaActualizacion: fechaActual
                };

                actualizarTablaInventario();

                document.getElementById('cantidadInventario').value = '';
                document.getElementById('tipoProductoInventario').value = '';

                updateConnectionStatus('connected', 'Inventario actualizado correctamente');
                mostrarAlerta(`Se restaron ${cantidad} lbs de ${tipo}`, 'success');

            } catch (error) {
                updateConnectionStatus('disconnected', `Error: ${error.message}`);
                mostrarAlerta(`Error al actualizar inventario: ${error.message}`, 'danger');
            }
        }

        // =================== FUNCIONES DE VENTAS ===================

        function agregarProductoVenta() {
            const tipo = document.getElementById('tipoProductoVenta').value;
            const cantidad = parseFloat(document.getElementById('cantidadVenta').value) || 0;

            if (!tipo || cantidad <= 0) {
                mostrarAlerta('Seleccione un producto e ingrese una cantidad v√°lida', 'warning');
                return;
            }

            const stockDisponible = inventarioData[tipo]?.stock || 0;
            if (cantidad > stockDisponible) {
                mostrarAlerta(`No hay suficiente stock. Disponible: ${stockDisponible.toFixed(1)} lbs`, 'danger');
                return;
            }

            const precioUnitario = preciosData[tipo]?.precioVenta || 0;
            const subtotal = cantidad * precioUnitario;

            ventaActual.push({
                tipo,
                cantidad,
                precioUnitario,
                subtotal
            });

            actualizarVistaVenta();

            document.getElementById('tipoProductoVenta').value = '';
            document.getElementById('cantidadVenta').value = '';

            mostrarAlerta(`${tipo} agregado a la venta`, 'success');
        }

        function actualizarVistaVenta() {
            const container = document.getElementById('productosVenta');
            container.innerHTML = '';

            let total = 0;

            ventaActual.forEach((producto, index) => {
                total += producto.subtotal;

                const div = document.createElement('div');
                div.className = 'venta-item';
                div.innerHTML = `
                    <div>
                        <strong>${producto.tipo}</strong><br>
                        ${producto.cantidad.toFixed(1)} lbs √ó ${formatearPesos(producto.precioUnitario)} = ${formatearPesos(producto.subtotal)}
                    </div>
                    <button class="btn btn-danger" onclick="eliminarProductoVenta(${index})">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });

            document.getElementById('totalVenta').textContent = formatearPesos(total);
        }

        function eliminarProductoVenta(index) {
            ventaActual.splice(index, 1);
            actualizarVistaVenta();
            mostrarAlerta('Producto eliminado de la venta', 'warning');
        }

        async function finalizarVenta() {
            const cliente = document.getElementById('clienteVenta').value.trim();

            if (!cliente) {
                mostrarAlerta('Ingrese el nombre del cliente', 'warning');
                return;
            }

            if (ventaActual.length === 0) {
                mostrarAlerta('Agregue al menos un producto a la venta', 'warning');
                return;
            }

            if (!confirm('¬øConfirmar esta venta?')) {
                return;
            }

            updateConnectionStatus('connecting', 'Procesando venta...');

            try {
                // Obtener n√∫mero de factura actual
                const configData = await leerHoja('Configuracion!A2:D2');
                numeroFactura = parseInt(configData[0][0]) || 1;

                const fechaActual = new Date().toISOString().split('T')[0];
                let total = 0;
                let productosTexto = '';

                // Procesar cada producto
                for (const producto of ventaActual) {
                    total += producto.subtotal;
                    productosTexto += `${producto.tipo} (${producto.cantidad.toFixed(1)} lbs), `;

                    // Actualizar inventario
                    const stockActual = inventarioData[producto.tipo]?.stock || 0;
                    const precioPromActual = inventarioData[producto.tipo]?.precioPromedio || 0;
                    const nuevoStock = stockActual - producto.cantidad;
                    const nuevoValorTotal = nuevoStock * precioPromActual;

                    const inventarioDatos = await leerHoja('Inventario!A2:E100');
                    let filaInventario = -1;

                    inventarioDatos.forEach((fila, index) => {
                        if (fila[0] === producto.tipo) {
                            filaInventario = index + 2;
                        }
                    });

                    if (filaInventario !== -1) {
                        await escribirHoja(`Inventario!A${filaInventario}:E${filaInventario}`, 
                            [[producto.tipo, nuevoStock, precioPromActual, nuevoValorTotal, fechaActual]]);

                        inventarioData[producto.tipo].stock = nuevoStock;
                        inventarioData[producto.tipo].valorTotal = nuevoValorTotal;
                        inventarioData[producto.tipo].ultimaActualizacion = fechaActual;
                    }
                }

                productosTexto = productosTexto.slice(0, -2);

                // Registrar venta
                await agregarFila('Ventas!A:E', [numeroFactura, fechaActual, cliente, productosTexto, total]);

                // Actualizar n√∫mero de factura
                numeroFactura++;
                await escribirHoja('Configuracion!A2:A2', [[numeroFactura]]);

                // Generar factura
                generarFactura(numeroFactura - 1, fechaActual, cliente, ventaActual, total);

                // Limpiar venta
                ventaActual = [];
                document.getElementById('clienteVenta').value = '';
                actualizarVistaVenta();
                actualizarTablaInventario();

                updateConnectionStatus('connected', 'Venta procesada correctamente');
                mostrarAlerta(`Venta #${numeroFactura - 1} registrada exitosamente`, 'success');

                // Imprimir factura
                setTimeout(() => {
                    if (confirm('¬øDesea imprimir la factura?')) {
                        window.print();
                    }
                }, 500);

            } catch (error) {
                updateConnectionStatus('disconnected', `Error: ${error.message}`);
                mostrarAlerta(`Error al procesar venta: ${error.message}`, 'danger');
            }
        }

        function generarFactura(numero, fecha, cliente, productos, total) {
            const facturaDiv = document.getElementById('facturaImpresion');

            let productosHTML = '';
            productos.forEach(p => {
                productosHTML += `
                    <tr>
                        <td>${p.tipo}</td>
                        <td>${p.cantidad.toFixed(1)} lbs</td>
                        <td>${formatearPesos(p.precioUnitario)}</td>
                        <td>${formatearPesos(p.subtotal)}</td>
                    </tr>
                `;
            });

            facturaDiv.innerHTML = `
                <div class="factura-preview">
                    <div class="factura-header">
                        <h1>üêü ${config.nombreEmpresa}</h1>
                        <p>${config.direccionEmpresa}</p>
                        <p>Tel: ${config.telefonoEmpresa}</p>
                        <h2>FACTURA DE VENTA</h2>
                        <p>Factura #${numero.toString().padStart(6, '0')}</p>
                    </div>

                    <div class="factura-info">
                        <div>
                            <strong>Fecha:</strong> ${fecha}<br>
                            <strong>Cliente:</strong> ${cliente}
                        </div>
                    </div>

                    <div class="factura-productos">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productosHTML}
                            </tbody>
                        </table>
                    </div>

                    <div class="factura-total">
                        TOTAL: ${formatearPesos(total)}
                    </div>

                    <p style="text-align: center; margin-top: 30px; color: #666;">
                        ¬°Gracias por su compra!
                    </p>
                </div>
            `;
        }

        // =================== FUNCIONES DE CONFIGURACI√ìN ===================

        function guardarConfiguracion() {
            const id = document.getElementById('spreadsheetId').value.trim();

            if (!id) {
                mostrarAlerta('Ingrese un ID de hoja de c√°lculo v√°lido', 'warning');
                return;
            }

            spreadsheetId = id;
            localStorage.setItem('spreadsheetId', spreadsheetId);

            updateConnectionStatus('connected', 'Configuraci√≥n guardada');
            mostrarAlerta('Configuraci√≥n guardada correctamente', 'success');

            cargarTodosLosDatos();
        }

        function guardarDatosEmpresa() {
            config.nombreEmpresa = document.getElementById('nombreEmpresa').value;
            config.direccionEmpresa = document.getElementById('direccionEmpresa').value;
            config.telefonoEmpresa = document.getElementById('telefonoEmpresa').value;

            localStorage.setItem('nombreEmpresa', config.nombreEmpresa);
            localStorage.setItem('direccionEmpresa', config.direccionEmpresa);
            localStorage.setItem('telefonoEmpresa', config.telefonoEmpresa);

            mostrarAlerta('Datos de empresa guardados correctamente', 'success');
        }

        async function cargarTodosLosDatos() {
            if (!spreadsheetId) {
                mostrarAlerta('Configure primero el ID de la hoja de c√°lculo', 'warning');
                return;
            }

            updateConnectionStatus('connecting', 'Cargando todos los datos...');

            try {
                await cargarPrecios();
                await cargarInventario();

                updateConnectionStatus('connected', 'Todos los datos cargados');
                mostrarAlerta('Todos los datos cargados correctamente', 'success');
            } catch (error) {
                updateConnectionStatus('disconnected', `Error: ${error.message}`);
                mostrarAlerta(`Error al cargar datos: ${error.message}`, 'danger');
            }
        }

        // =================== FUNCIONES DE REPORTES ===================

        window.cargarReportes = async function() {
            const btnCargar = event.target;
            btnCargar.disabled = true;
            btnCargar.innerHTML = '<span class="loading"></span> CARGANDO...';

            updateConnectionStatus('connecting', 'Cargando reportes...');

            try {
                // Cargar ventas
                const ventasData = await leerHoja('Ventas!A2:E1000');

                if (ventasData && ventasData.length > 0) {
                    const hoy = new Date().toISOString().split('T')[0];
                    const mesActual = hoy.substring(0, 7);

                    let totalHoy = 0;
                    let totalMes = 0;
                    let gananciasMes = 0;
                    let numeroFacturas = 0;
                    let ventasParaTabla = [];

                    ventasData.forEach(fila => {
                        if (fila[1]) {
                            const fecha = fila[1];
                            const total = parseFloat(fila[4]) || 0;
                            
                            // Calcular totales
                            if (fecha === hoy) {
                                totalHoy += total;
                            }

                            if (fecha.startsWith(mesActual)) {
                                totalMes += total;
                                numeroFacturas++;
                                
                                // Calcular ganancias del mes
                                const productosTexto = fila[3] || '';
                                const productos = productosTexto.split(', ');
                                
                                productos.forEach(productoStr => {
                                    const match = productoStr.match(/^(.+)\s+\(([0-9.]+)\s+lbs\)$/);
                                    if (match) {
                                        const tipo = match[1].trim();
                                        const cantidad = parseFloat(match[2]);
                                        
                                        if (preciosData[tipo]) {
                                            const gananciaPorLb = preciosData[tipo].ganancia || 0;
                                            gananciasMes += (cantidad * gananciaPorLb);
                                        }
                                    }
                                });
                                
                                ventasParaTabla.push({
                                    numero: parseInt(fila[0]) || 0,
                                    fecha: fecha,
                                    cliente: fila[2] || '',
                                    productos: fila[3] || '',
                                    total: total
                                });
                            }
                        }
                    });

                    // Calcular valor total del inventario
                    let totalInventario = 0;
                    for (const tipo in inventarioData) {
                        totalInventario += inventarioData[tipo].valorTotal;
                    }

                    // Actualizar estad√≠sticas
                    document.getElementById('totalVentasHoy').textContent = formatearPesos(totalHoy);
                    document.getElementById('totalVentasMes').textContent = formatearPesos(totalMes);
                    document.getElementById('gananciasMes').textContent = formatearPesos(gananciasMes);
                    document.getElementById('totalInventario').textContent = formatearPesos(totalInventario);
                    document.getElementById('numeroFacturas').textContent = numeroFacturas;

                    // Actualizar tabla de √∫ltimas ventas (√∫ltimas 10)
                    actualizarTablaUltimasVentas(ventasParaTabla.slice(-10).reverse());

                    // Actualizar tabla de stock bajo
                    actualizarTablaStockBajo();

                    updateConnectionStatus('connected', 'Reportes cargados correctamente');
                    mostrarAlerta('Reportes actualizados correctamente', 'success');

                } else {
                    document.getElementById('totalVentasHoy').textContent = '$0.00';
                    document.getElementById('totalVentasMes').textContent = '$0.00';
                    document.getElementById('gananciasMes').textContent = '$0.00';
                    document.getElementById('numeroFacturas').textContent = '0';

                    mostrarAlerta('No hay datos de ventas disponibles', 'warning');
                }

            } catch (error) {
                updateConnectionStatus('disconnected', `Error: ${error.message}`);
                mostrarAlerta(`Error al cargar reportes: ${error.message}`, 'danger');
            } finally {
                btnCargar.disabled = false;
                btnCargar.innerHTML = 'üîÑ ACTUALIZAR REPORTES';
            }
        };

        // Actualizar tabla de √∫ltimas ventas
        function actualizarTablaUltimasVentas(ventas) {
            const tbody = document.querySelector('#tablaUltimasVentas tbody');
            tbody.innerHTML = '';

            if (ventas.length === 0) {
                const fila = tbody.insertRow();
                fila.innerHTML = '<td colspan="5" style="text-align: center;">No hay ventas registradas</td>';
                return;
            }

            ventas.forEach(venta => {
                const fila = tbody.insertRow();
                fila.innerHTML = `
                    <td>#${venta.numero.toString().padStart(6, '0')}</td>
                    <td>${venta.fecha}</td>
                    <td>${venta.cliente}</td>
                    <td>${venta.productos}</td>
                    <td>${formatearPesos(venta.total)}</td>
                `;
            });
        }

        // Actualizar tabla de stock bajo
        function actualizarTablaStockBajo() {
            const tbody = document.querySelector('#tablaStockBajo tbody');
            tbody.innerHTML = '';

            const stockBajo = Object.entries(inventarioData).filter(([tipo, datos]) => datos.stock < 10);

            if (stockBajo.length === 0) {
                const fila = tbody.insertRow();
                fila.innerHTML = '<td colspan="3" style="text-align: center;">‚úÖ Todos los productos tienen stock suficiente</td>';
                return;
            }

            stockBajo.forEach(([tipo, datos]) => {
                const fila = tbody.insertRow();

                let estado = 'üü° Stock Bajo';
                let claseEstado = 'style="background-color: #fff3cd;"';

                if (datos.stock === 0) {
                    estado = 'üî¥ Agotado';
                    claseEstado = 'style="background-color: #f8d7da;"';
                } else if (datos.stock < 5) {
                    estado = 'üü† Cr√≠tico';
                    claseEstado = 'style="background-color: #f8d7da;"';
                }

                fila.innerHTML = `
                    <td>${tipo}</td>
                    <td>${datos.stock.toFixed(1)} lbs</td>
                    <td ${claseEstado}>${estado}</td>
                `;
            });
        }

        // =================== INICIALIZACI√ìN ===================

        // Cargar configuraci√≥n guardada al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ DOM cargado, inicializando sistema...');
            verificarSesion();

            // Cargar configuraci√≥n guardada
            if (spreadsheetId) {
                document.getElementById('spreadsheetId').value = spreadsheetId;
                updateConnectionStatus('connected', 'Configuraci√≥n cargada desde localStorage');
            } else {
                updateConnectionStatus('disconnected', 'Configure el sistema para comenzar');
            }

            // Cargar datos de empresa
            document.getElementById('nombreEmpresa').value = config.nombreEmpresa;
            document.getElementById('direccionEmpresa').value = config.direccionEmpresa;
            document.getElementById('telefonoEmpresa').value = config.telefonoEmpresa;

            console.log('‚úÖ Sistema inicializado correctamente');
        });

        console.log('üéØ Todas las funciones definidas correctamente');

        // =================== FUNCIONES DE AUTENTICACI√ìN ===================

        // Credenciales del sistema
        const USUARIO_VALIDO = 'pesquera';
        const CONTRASE√ëA_VALIDA = 'gloria11';

        // Variables de sesi√≥n
        let sesionActiva = localStorage.getItem('sesionPesquera') === 'true';

        // Funci√≥n para alternar visibilidad de contrase√±a
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const showPasswordCheckbox = document.getElementById('showPassword');

            if (showPasswordCheckbox.checked) {
                passwordInput.type = 'text';
            } else {
                passwordInput.type = 'password';
            }
        }

        // Funci√≥n para iniciar sesi√≥n
        function iniciarSesion(event) {
            event.preventDefault();

            const usuario = document.getElementById('username').value.trim();
            const contrase√±a = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');

            // Deshabilitar bot√≥n y mostrar carga
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading"></span> VERIFICANDO...';

            // Simular verificaci√≥n
            setTimeout(() => {
                if (usuario === USUARIO_VALIDO && contrase√±a === CONTRASE√ëA_VALIDA) {
                    // Login exitoso
                    localStorage.setItem('sesionPesquera', 'true');
                    localStorage.setItem('ultimoLogin', new Date().toISOString());

                    mostrarSistema();

                    // Limpiar formulario
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    errorDiv.style.display = 'none';

                } else {
                    // Login fallido
                    errorDiv.textContent = '‚ùå Usuario o contrase√±a incorrectos';
                    errorDiv.style.display = 'block';

                    // Limpiar contrase√±a
                    document.getElementById('password').value = '';
                    document.getElementById('password').focus();
                }

                // Restaurar bot√≥n
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'üîë INICIAR SESI√ìN';

            }, 1000);
        }

        // Funci√≥n para mostrar el sistema principal
        function mostrarSistema() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('sistemaPrincipal').style.display = 'block';

            console.log('‚úÖ Sesi√≥n iniciada correctamente');

            // Cargar datos si ya est√° configurado
            if (spreadsheetId) {
                cargarTodosLosDatos();
            }
        }

        // Funci√≥n para cerrar sesi√≥n
        function cerrarSesion() {
            if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                localStorage.removeItem('sesionPesquera');
                localStorage.removeItem('ultimoLogin');

                document.getElementById('sistemaPrincipal').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';

                // Limpiar datos sensibles
                ventaActual = [];

                console.log('üö™ Sesi√≥n cerrada correctamente');
            }
        }

        // Funci√≥n para verificar sesi√≥n al cargar la p√°gina (8 horas de duraci√≥n)
        function verificarSesion() {
            const sesionGuardada = localStorage.getItem('sesionPesquera') === 'true';
            const ultimoLogin = localStorage.getItem('ultimoLogin');

            if (sesionGuardada && ultimoLogin) {
                const tiempoLogin = new Date(ultimoLogin);
                const ahora = new Date();
                const diferenciaHoras = (ahora - tiempoLogin) / (1000 * 60 * 60);

                // Sesi√≥n v√°lida por 8 horas
                if (diferenciaHoras < 8) {
                    mostrarSistema();
                    return;
                } else {
                    // Sesi√≥n expirada
                    localStorage.removeItem('sesionPesquera');
                    localStorage.removeItem('ultimoLogin');
                }
            }

            // Mostrar login por defecto
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('sistemaPrincipal').style.display = 'none';
        }

    </script>
</body>
</html>
